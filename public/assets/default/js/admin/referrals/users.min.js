(function ($) {
    "use strict";

    $("#filters-form").on("submit", function (e) {
        e.preventDefault();

        var form = $(this);
        var url = form.attr("action");
        var data = form.serialize();

        Swal.fire({
            title: 'Loading...',
            text: 'Please wait while we fetch the data.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            },
            customClass: {
                container: 'swal2-container'
            }
        });

        $.ajax({
            url: url,
            type: "GET",
            data: data,
            success: function (response) {
                Swal.close();

                // Update affiliates table content
                $("#affiliates-table").html(
                    $(response).find("#affiliates-table").html()
                );

                // Reinitialize view details buttons
                initializeViewDetailsButtons();
            },
            error: function (xhr) {
                Swal.close();

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while fetching the data. Please try again later.'
                });

                console.log("Error:", xhr);
            }
        });
    });

    // Function to initialize view details buttons
    function initializeViewDetailsButtons() {
        $(".view-details").off("click").on("click", function () {
            var details = JSON.parse($(this).attr("data-details"));
            var username = $(this).attr("data-username");

            $("#affiliateDetailModalLabel").text(username + " - Details");

            var tableBody = $("#affiliateDetailTableBody");
            tableBody.empty(); // Clear existing table rows

            details.forEach(function (detail) {
                var row = $("<tr></tr>");

                var webinarIdCell = $("<td></td>").text(detail.webinar_id);
                var amountCell = $("<td></td>").text(detail.amount);
                var dateCell = $("<td></td>").text(new Date(detail.created_at * 1000).toISOString().split("T")[0]);
                var paidStatusCell = $("<td></td>");

                var paidStatusCheckbox = $('<input type="checkbox" class="paid-status-checkbox" data-detail-id="' + detail.id + '">');
                if (detail.paid_date) {
                    paidStatusCheckbox.prop('checked', true);
                } else {
                    paidStatusCheckbox.prop('checked', false);
                }

                paidStatusCell.append(paidStatusCheckbox);

                var paidDateCell = $("<td></td>").text(detail.paid_date ? new Date(detail.paid_date * 1000).toISOString().split("T")[0] : "-");

                row.append(webinarIdCell);
                row.append(amountCell);
                row.append(dateCell);
                row.append(paidStatusCell);
                row.append(paidDateCell);

                tableBody.append(row);
            });

            $(".paid-status-checkbox").off("change").on("change", function () {
                var detailId = $(this).data("detail-id");
                var isChecked = $(this).is(":checked");
                var $checkbox = $(this);
                var $paidDateCell = $checkbox.closest('td').next('td');

                Swal.fire({
                    title: 'Updating...',
                    text: 'Updating the payment status.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        container: 'swal2-container'
                    }
                });

                // A LOT TO DO STILL

                // ON MODAL OPEN CLICK GET THE ACCOUNTING DATA, WITH THE USER ID MONTH Date
                // THEN UPDATE THE PAID DATE 

                $.ajax({
                    url: '/admin/referrals/update-paid-status',
                    type: 'POST',
                    data: {
                        id: detailId,
                        paid_status: isChecked,
                        paid_date: Math.floor(Date.now() / 1000)  // Current timestamp
                    },
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function (response) {
                        Swal.close();
                        var paidDate = response.paid_date ? new Date(response.paid_date * 1000).toISOString().split("T")[0] : "-";
                        $paidDateCell.text(paidDate);

                        // Update details array to reflect changes
                        details.forEach(function (detail) {
                            if (detail.id === detailId) {
                                detail.paid_date = response.paid_date;
                            }
                        });
                    },
                    error: function (xhr) {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while updating the payment status. Please try again later.'
                        });

                        console.log("Error:", xhr);
                    }
                });
            });
        });
    }

    // Initialize view details buttons on document ready
    $(document).ready(function () {
        initializeViewDetailsButtons();
    });

})(jQuery);